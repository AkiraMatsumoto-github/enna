---

---

<section
    class="schedule-container bg-white w-full rounded-3xl p-6 md:p-8 shadow-sm border border-brand-light/50 overflow-hidden relative group my-8"
>
    <div class="flex items-center justify-between mb-6">
        <h3
            class="text-xl md:text-2xl font-bold text-brand-accent flex items-center gap-2"
        >
            <span class="inline-block w-2 h-6 bg-brand-main rounded-full"
            ></span>
            予約スケジュール
        </h3>
        <div class="flex gap-2">
            <button
                id="prev-month"
                class="p-2 hover:bg-brand-base rounded-full transition-colors text-brand-main disabled:opacity-30 disabled:hover:bg-transparent"
                disabled
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path d="m15 18-6-6 6-6"></path></svg
                >
            </button>
            <span
                id="current-month-label"
                class="text-xl font-bold text-brand-text min-w-[120px] text-center flex items-center justify-center font-en"
            >
                <!-- JSで挿入 -->
            </span>
            <button
                id="next-month"
                class="p-2 hover:bg-brand-base rounded-full transition-colors text-brand-main"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg
                >
            </button>
        </div>
    </div>

    <div class="relative min-h-[300px]">
        <!-- Loading State -->
        <div
            id="calendar-loading"
            class="absolute inset-0 flex items-center justify-center bg-white/80 z-10 transition-opacity duration-300"
        >
            <div
                class="animate-spin rounded-full h-10 w-10 border-4 border-brand-base border-t-brand-main"
            >
            </div>
        </div>

        <!-- Error State -->
        <div
            id="calendar-error"
            class="hidden absolute inset-0 flex flex-col items-center justify-center bg-white z-10 text-center p-4"
        >
            <p class="text-brand-text mb-4">
                スケジュールの読み込みに失敗しました。
            </p>
            <a
                href="https://kidsline.me/sitters/show/u1351176829"
                target="_blank"
                rel="noopener noreferrer"
                class="text-brand-main font-bold hover:underline"
            >
                Kidsline公式ページで確認する
            </a>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid">
            <div
                class="grid grid-cols-7 gap-1 mb-2 text-center text-sm font-bold text-brand-text/70"
            >
                <div class="text-red-400">日</div>
                <div>月</div>
                <div>火</div>
                <div>水</div>
                <div>木</div>
                <div>金</div>
                <div class="text-blue-400">土</div>
            </div>
            <div id="calendar-days" class="grid grid-cols-7 gap-1 md:gap-2">
                <!-- JSで挿入 -->
            </div>
        </div>
    </div>

    <div
        class="mt-6 flex flex-wrap gap-4 text-sm justify-center md:justify-end"
    >
        <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-red-100 border border-red-200"
            ></span>
            <span class="text-brand-text/80">予約可能 (◎)</span>
        </div>
        <div class="flex items-center gap-2">
            <span
                class="w-3 h-3 rounded-full bg-orange-100 border border-orange-200"
            ></span>
            <span class="text-brand-text/80">一部可能 (△)</span>
        </div>
        <div class="flex items-center gap-2">
            <span
                class="w-3 h-3 rounded-full bg-gray-100 border border-gray-200"
            ></span>
            <span class="text-brand-text/80">満枠・不可 (×)</span>
        </div>
    </div>

    <div class="mt-4 text-center md:text-right">
        <a
            href="https://kidsline.me/sitters/show/u1351176829#calendar"
            target="_blank"
            rel="noopener noreferrer"
            class="text-xs text-brand-text/60 hover:text-brand-main underline"
        >
            ※最新情報はKidsline公式サイトをご確認ください
        </a>
    </div>
</section>

<script>
    class ScheduleCalendar {
        constructor() {
            this.currentDate = new Date(); // 表示中の月（1日）
            this.today = new Date();

            this.els = {
                days: document.getElementById("calendar-days"),
                label: document.getElementById("current-month-label"),
                prevBtn: document.getElementById("prev-month"),
                nextBtn: document.getElementById("next-month"),
                loading: document.getElementById("calendar-loading"),
                error: document.getElementById("calendar-error"),
            };

            this.init();
        }

        init() {
            if (!this.els.days) return;

            this.updateHeader();
            this.fetchAndRender();

            this.els.prevBtn?.addEventListener("click", () =>
                this.changeMonth(-1),
            );
            this.els.nextBtn?.addEventListener("click", () =>
                this.changeMonth(1),
            );
        }

        changeMonth(delta) {
            this.currentDate.setMonth(this.currentDate.getMonth() + delta);
            this.updateHeader();
            this.updateButtons();
            this.fetchAndRender();
        }

        updateHeader() {
            const year = this.currentDate.getFullYear();
            const month = this.currentDate.getMonth() + 1;
            this.els.label.textContent = `${year}.${month.toString().padStart(2, "0")}`;
        }

        updateButtons() {
            // 過去月への移動を制限（必要であれば）
            const isCurrentMonth =
                this.currentDate.getFullYear() === this.today.getFullYear() &&
                this.currentDate.getMonth() === this.today.getMonth();

            if (this.els.prevBtn) {
                this.els.prevBtn.disabled = isCurrentMonth;
            }
        }

        async fetchAndRender() {
            this.setLoading(true);
            this.setError(false);

            // 月初の1日
            const start = new Date(
                this.currentDate.getFullYear(),
                this.currentDate.getMonth(),
                1,
            );
            // 月末
            const end = new Date(
                this.currentDate.getFullYear(),
                this.currentDate.getMonth() + 1,
                0,
            );

            // API用フォーマット (YYYY-MM-DD)
            // カレンダー表示のために前後の余白日も含めるのが一般的だが、
            // 今回はシンプルに月初〜月末のイベントを取得して、グリッド描画時にマッピングする
            // KidslineのAPIはstart/endの範囲のイベントを返す

            // FullCalendar的なロジック: 表示するカレンダーの開始日（前の月の余り）と終了日（次の月の最初）を計算
            const calendarStartDate = new Date(start);
            calendarStartDate.setDate(1 - start.getDay()); // 日曜始まりにするための補正

            const calendarEndDate = new Date(end);
            calendarEndDate.setDate(end.getDate() + (6 - end.getDay())); // 土曜終わりにするための補正

            const formatDate = (d) => {
                return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, "0")}-${d.getDate().toString().padStart(2, "0")}`;
            };

            try {
                const queryStart = formatDate(calendarStartDate);
                const queryEnd = formatDate(calendarEndDate);

                const res = await fetch(
                    `/api/schedule.json?start=${queryStart}&end=${queryEnd}`,
                );
                if (!res.ok) throw new Error("API Error");
                const events = await res.json();

                this.renderGrid(calendarStartDate, calendarEndDate, events);
            } catch (e) {
                console.error(e);
                this.setError(true);
            } finally {
                this.setLoading(false);
            }
        }

        renderGrid(startDate, endDate, events) {
            this.els.days.innerHTML = "";

            // イベントをマップ化 (YYYY-MM-DD -> type)
            const eventMap = {};
            events.forEach((ev) => {
                // kidsline API returns start as "2026-01-01T00:00:00.000+09:00"
                const dateStr = ev.start.split("T")[0];
                eventMap[dateStr] = ev;
            });

            let d = new Date(startDate);
            while (d <= endDate) {
                const dateStr = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, "0")}-${d.getDate().toString().padStart(2, "0")}`;
                const isToday =
                    dateStr ===
                    `${this.today.getFullYear()}-${(this.today.getMonth() + 1).toString().padStart(2, "0")}-${this.today.getDate().toString().padStart(2, "0")}`;
                const isCurrentMonth =
                    d.getMonth() === this.currentDate.getMonth();
                const event = eventMap[dateStr];

                const cell = document.createElement("div");
                cell.className = `
          aspect-square rounded-lg md:rounded-xl p-1 flex flex-col items-center justify-start pt-2 relative border border-transparent
          ${!isCurrentMonth ? "opacity-30 bg-gray-50" : "bg-white"}
          ${isToday ? "border-brand-main/50 bg-brand-base/10" : ""}
        `;

                // ステータス判定
                // type: 0 -> ○ (Available) ? 推測要検証だがログでは type:0, detail:0 が ○
                // type: 2 -> × (Full)
                // type: ? -> △ (Partial)
                // ログの "type":2, "type_detail":3 が ×
                // "type":0, "type_detail":0 が ○
                // "type":2, "type_detail":2 が × (時間指定あり?) -> おそらく一部不可も×扱いか？
                // BrowserSubagentの結果では "type_detail"までは見ていないが、○と×はある。
                // シンプルに title "○", "×" で判定するのが確実そう。

                let statusHtml =
                    '<span class="text-xs text-gray-300 mt-1">-</span>';
                let bgClass = "";

                if (event) {
                    const startDate = new Date(event.start);
                    const endDate = new Date(event.end);
                    const formatTime = (d) =>
                        `${d.getHours()}:${d.getMinutes().toString().padStart(2, "0")}`;
                    // 0分などの表記をきれいにするため、分が00の場合は省略せずそのまま表示
                    // 時間を表示するかどうかの判定（9:00 - 18:00のような実時間がある場合のみ）
                    const hasTime =
                        startDate.getHours() !== 0 ||
                        startDate.getMinutes() !== 0 ||
                        endDate.getHours() !== 0 ||
                        endDate.getMinutes() !== 0;

                    const timeHtml = hasTime
                        ? `<span class="text-[10px] leading-tight text-gray-500 mt-0.5 text-center font-midium tracking-tighter">${formatTime(startDate)}-${formatTime(endDate)}</span>`
                        : "";

                    if (event.title === "○" || event.title === "◎") {
                        statusHtml = `<div class="flex flex-col items-center">
                            <span class="text-lg md:text-xl font-bold text-red-400 leading-none mt-1 hidden md:block">◎</span>
                            <span class="text-base md:text-lg font-bold text-red-400 leading-none mt-1 block md:hidden">◎</span>
                            ${timeHtml}
                        </div>`;
                        bgClass = "bg-red-50 hover:bg-red-100 cursor-pointer";
                    } else if (event.title === "×") {
                        statusHtml =
                            '<span class="text-lg md:text-xl font-bold text-gray-300 leading-none mt-1">×</span>';
                        bgClass = "bg-gray-50";
                    } else if (event.title === "△") {
                        statusHtml = `<div class="flex flex-col items-center">
                            <span class="text-lg md:text-xl font-bold text-orange-400 leading-none mt-1 hidden md:block">△</span>
                            <span class="text-base md:text-lg font-bold text-orange-400 leading-none mt-1 block md:hidden">△</span>
                            ${timeHtml}
                        </div>`;
                        bgClass =
                            "bg-orange-50 hover:bg-orange-100 cursor-pointer";
                    }
                }

                if (bgClass && isCurrentMonth) {
                    cell.className += ` ${bgClass}`;
                }

                cell.innerHTML = `
          <span class="text-xs md:text-sm font-bold ${d.getDay() === 0 ? "text-red-400" : d.getDay() === 6 ? "text-blue-400" : "text-brand-text"}">
            ${d.getDate()}
          </span>
          ${isCurrentMonth ? statusHtml : ""}
        `;

                this.els.days.appendChild(cell);

                // 翌日へ
                d.setDate(d.getDate() + 1);
            }
        }

        setLoading(isLoading) {
            if (this.els.loading) {
                this.els.loading.style.opacity = isLoading ? "1" : "0";
                this.els.loading.style.pointerEvents = isLoading
                    ? "auto"
                    : "none";
            }
        }

        setError(isError) {
            if (this.els.error) {
                this.els.error.classList.toggle("hidden", !isError);
            }
        }
    }

    // Init
    document.addEventListener("DOMContentLoaded", () => {
        new ScheduleCalendar();
    });
</script>
